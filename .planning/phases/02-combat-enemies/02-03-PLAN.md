---
phase: 02-combat-enemies
plan: 03
type: execute
---

<objective>
Integrate combat system with turn-based flow and spawn enemies in GameScene.

Purpose: Connect all combat pieces into a working turn-based game loop. Player moves → enemies act → repeat. Complete Phase 2 with playable tactical combat.
Output: Turn management system with FSM, enemies spawning in dungeon, full combat loop functional.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-combat-enemies/02-RESEARCH.md
@.planning/phases/02-combat-enemies/02-01-SUMMARY.md
@.planning/phases/02-combat-enemies/02-02-SUMMARY.md

**From Plan 02-01:**
- CombatStats, CombatEntity interfaces
- CombatSystem with damage calculation
- Player has combat capability

**From Plan 02-02:**
- Enemy base class with AI
- Three enemy types (Goblin, Archer, Brute)
- AISystem with Rot.js pathfinding

**Research guidance:**
- Use enum-based FSM for turn management (PLAYER_TURN → ENEMY_TURN)
- Simple turn order: player acts, then all enemies act
- Start with 3-5 enemies per dungeon
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TurnManager with FSM</name>
  <files>src/systems/TurnManager.ts, src/types/index.ts</files>
  <action>
    In src/types/index.ts:
    - Add TurnState enum with: PLAYER_TURN, ENEMY_TURN

    In src/systems/TurnManager.ts:
    - Create TurnManager class
    - Properties:
      - private state: TurnState = TurnState.PLAYER_TURN
      - private enemies: Enemy[] = []
    - addEnemy(enemy: Enemy): void - adds enemy to tracking array
    - removeEnemy(enemy: Enemy): void - removes from array (when killed)
    - isPlayerTurn(): boolean - returns this.state === TurnState.PLAYER_TURN
    - endPlayerTurn(player: Player, map: number[][]): void
      - Set state to ENEMY_TURN
      - Loop through enemies:
        - If enemy.isAlive(), call enemy.selectAction(player, map)
        - Remove dead enemies from array
      - Set state back to PLAYER_TURN
    - getCurrentState(): TurnState - returns this.state

    IMPORTANT: Keep it simple per research. No complex action queues or priority systems. Player moves → enemies act → back to player. FSM using TypeScript enum for clean state management.
  </action>
  <verify>TypeScript compiles, TurnManager exports correctly, TurnState enum exists</verify>
  <done>TurnManager created with enum-based FSM, manages turn flow between player and enemies</done>
</task>

<task type="auto">
  <name>Task 2: Integrate combat into GameScene</name>
  <files>src/scenes/GameScene.ts</files>
  <action>
    In src/scenes/GameScene.ts:
    - Import Enemy, Goblin, Archer, Brute, TurnManager, AISystem
    - Add private properties:
      - enemies: Enemy[] = []
      - turnManager: TurnManager | null = null

    - In create() method (after player creation):
      - Create turnManager: this.turnManager = new TurnManager()
      - Spawn 3-5 enemies randomly on floor tiles:
        - Loop 3-5 times
        - Find random floor tile (value === 0) that's not occupied by player
        - Randomly choose enemy type (Goblin, Archer, or Brute)
        - Create enemy at that position
        - Call enemy.updateSpritePosition(this.gridManager)
        - Add to this.enemies array
        - Add to turnManager.addEnemy(enemy)

    - In update() method (modify existing player input):
      - Check if (!this.turnManager || !this.turnManager.isPlayerTurn()) return early
      - After player.move() succeeds:
        - Call this.turnManager.endPlayerTurn(this.player, this.map)
        - Check for dead enemies after enemy turn:
          - Remove from this.enemies array
          - Remove sprite
        - Check if player is dead (!this.player.isAlive()):
          - Display "Game Over" text
          - Stop accepting input (set this.player = null)

    AVOID: Don't add complex turn indicators or health bars yet. Focus on core turn flow working. Don't add animations (instant resolution for now).
  </action>
  <verify>TypeScript compiles, GameScene imports work, no runtime errors</verify>
  <done>Enemies spawn in dungeon, turn-based combat functional (player moves → enemies act), dead entities removed from game</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Turn-based tactical combat with three enemy types</what-built>
  <how-to-verify>
    1. Run: npm run dev
    2. Open browser to localhost:5173
    3. Confirm: 3-5 colored enemies appear in dungeon (red Goblins, yellow Archers, blue Brutes)
    4. Test player movement: Enemies should move/act after each player move
    5. Test combat: Move adjacent to enemy, press move toward enemy - player attacks
    6. Observe AI behaviors:
       - Red Goblins: Chase player aggressively
       - Yellow Archers: Try to maintain distance
       - Blue Brutes: Only attack when player is adjacent
    7. Test damage: Enemies should die after taking enough damage (sprite disappears)
    8. Test player death: Let enemies kill player - should see "Game Over" message
    9. Refresh page: New dungeon with new enemy positions
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] TurnManager FSM works (PLAYER_TURN → ENEMY_TURN → PLAYER_TURN)
- [ ] Enemies spawn on valid floor tiles
- [ ] Player actions trigger enemy turns
- [ ] Enemy AI behaviors are distinct (aggressive, ranged, defensive)
- [ ] Combat damage works (entities die when HP reaches 0)
- [ ] Player death is handled (game over state)
- [ ] Phase 2 complete: Tactical combat functional
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Turn-based combat loop works end-to-end
- Three enemy types with distinct behaviors
- Player can fight and defeat enemies
- Enemies can defeat player (game over)
- **Phase 2 complete** - Combat & Enemies milestone achieved

</success_criteria>

<output>
After completion, create `.planning/phases/02-combat-enemies/02-03-SUMMARY.md`:

# Phase 2 Plan 3: Turn Management & Combat Flow Summary

**Turn-based tactical combat integrated with enemy AI - Phase 2 complete**

## Accomplishments

- TurnManager with enum-based FSM (PLAYER_TURN → ENEMY_TURN)
- Enemies spawn randomly in dungeon (3-5 per run)
- Full combat loop: player moves → enemies act → damage resolves
- Three enemy behaviors working (aggressive, ranged, defensive)
- Game over state when player dies
- Phase 2 complete: Tactical combat functional

## Files Created/Modified

- `src/types/index.ts` - TurnState enum
- `src/systems/TurnManager.ts` - Turn flow management with FSM
- `src/scenes/GameScene.ts` - Enemy spawning, turn integration, game over handling

## Decisions Made

- 3-5 enemies per dungeon for initial balance
- Instant damage resolution (no animations yet, defer to polish phase)
- Simple game over text (no restart button yet, refresh to play again)
- Turn-based: player acts, all enemies act, back to player

## Issues Encountered

[Document any issues, or state "None"]

## Next Phase Readiness

**Phase 2 Complete** - Combat system established:
- ✅ Combat stats and damage calculation
- ✅ Three enemy types with distinct behaviors
- ✅ Turn-based combat flow with FSM
- ✅ AI using Rot.js pathfinding
- ✅ Player can fight and die

Ready for Phase 3: Procedural Generation
- Combat system ready for varied dungeon layouts
- Enemy spawning can adapt to room types
- Turn system supports any number of entities

## Next Step

Phase 2 complete. Ready for Phase 3 planning or can iterate on combat balance.
</output>
