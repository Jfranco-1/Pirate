---
phase: 01-foundation-core-loop
plan: 02
type: execute
---

<objective>
Implement grid coordinate system and render a procedurally generated dungeon using Rot.js map generation.

Purpose: Establish the core spatial system that separates game logic (grid coordinates) from rendering (pixel positions), and demonstrate Rot.js map generation working correctly.
Output: Dungeon map displayed on canvas with distinct floor/wall tiles in a grid layout.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-core-loop/01-RESEARCH.md
@.planning/phases/01-foundation-core-loop/01-01-SUMMARY.md

**Research guidance - Don't hand-roll:**
- Use Rot.js Map generators (Digger, Uniform, Cellular) for dungeon generation
- Map generators guarantee connectivity between rooms
- Custom dungeon generation leads to bugs (disconnected areas, invalid layouts)

**Research patterns:**
- Separate grid coordinates (x, y in tiles) from pixel positions (x, y in pixels)
- Create GridManager utility for conversion between coordinate systems
- Store map data as 2D array: 0 = floor (walkable), 1 = wall (blocked)

**Key files from plan 01-01:**
- src/scenes/GameScene.ts - Main game scene to modify
- src/main.ts - Game configuration (already set pixelArt: true)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GridManager utility for coordinate conversion</name>
  <files>src/systems/GridManager.ts, src/types/index.ts</files>
  <action>
    Create coordinate system following research Pattern 2 (Grid-Based Coordinate System):

    In src/types/index.ts:
    - Define GridPosition interface with x: number, y: number properties
    - Add comment explaining these are tile coordinates, not pixels

    In src/systems/GridManager.ts:
    - Create GridManager class with:
      - private readonly tileSize: number = 32 (32x32 pixel tiles, standard for web roguelikes)
      - private readonly gridWidth: number
      - private readonly gridHeight: number
      - constructor(gridWidth: number, gridHeight: number)
      - gridToPixel(gridPos: GridPosition): { x: number, y: number } - multiplies by tileSize
      - pixelToGrid(pixelX: number, pixelY: number): GridPosition - divides by tileSize, floors result
      - isValidPosition(pos: GridPosition): boolean - checks bounds
      - getGridWidth(): number
      - getGridHeight(): number

    Calculate grid dimensions in tiles: 800px / 32 = 25 tiles wide, 600px / 32 = ~18 tiles tall (adjust to 18 for clean division).

    AVOID: Don't mix grid and pixel coordinates in same variable. Always use GridPosition type for clarity.
  </action>
  <verify>TypeScript compiles without errors, GridManager class exports correctly</verify>
  <done>GridManager created with coordinate conversion methods, GridPosition type defined, no TypeScript errors</done>
</task>

<task type="auto">
  <name>Task 2: Generate dungeon with Rot.js and render to canvas</name>
  <files>src/scenes/GameScene.ts</files>
  <action>
    Implement dungeon generation and rendering in GameScene following research code examples:

    In GameScene.ts:
    1. Import ROT from 'rot-js' and GridManager
    2. Add private properties:
       - map: number[][] = [] (stores dungeon: 0 = floor, 1 = wall)
       - gridManager: GridManager
       - graphics: Phaser.GameObjects.Graphics (for drawing tiles)

    3. In create() method:
       - Initialize gridManager = new GridManager(25, 18)
       - Create Rot.js Digger map generator: new ROT.Map.Digger(25, 18)
       - Call digger.create() with callback that populates this.map array
       - Callback receives (x, y, value): if (!this.map[y]) this.map[y] = []; this.map[y][x] = value
       - Initialize this.graphics = this.add.graphics()
       - Call this.renderMap()

    4. Create renderMap() method:
       - Clear graphics: this.graphics.clear()
       - Loop through map array (nested y, x loops)
       - For each tile, convert grid position to pixel using gridManager.gridToPixel()
       - Draw filled rectangle:
         - Walls (value === 1): graphics.fillStyle(0x555555, 1) - gray
         - Floors (value === 0): graphics.fillStyle(0x222222, 1) - dark gray
       - graphics.fillRect(pixelX, pixelY, 32, 32)
       - Add 1px border: graphics.lineStyle(1, 0x000000); graphics.strokeRect(pixelX, pixelY, 32, 32)

    Remove the "Metric - Loading..." text from previous plan.

    IMPORTANT: Use Rot.js Map.Digger as specified in research (don't hand-roll dungeon generation). Digger creates rooms with corridors, guarantees connectivity.
  </action>
  <verify>TypeScript compiles, Rot.js imports work, map array populates with 0s and 1s, renderMap logic is correct</verify>
  <done>Dungeon generated with Rot.js Digger, map data stored in 2D array, rendering logic implemented for walls and floors</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run dev starts without errors
- [ ] Browser displays procedurally generated dungeon
- [ ] Map has distinct rooms and corridors (characteristic of Digger algorithm)
- [ ] Walls and floors are visually distinct (different colors)
- [ ] Grid alignment is correct (no offset issues)
- [ ] Refreshing page generates new dungeon layout (procedural generation working)
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Dungeon renders correctly with Rot.js generation
- Grid coordinate system functional
- Map data structure ready for player entity (next plan)

</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-core-loop/01-02-SUMMARY.md`:

# Phase 1 Plan 2: Grid System & Map Rendering Summary

**Grid coordinate system established and Rot.js procedural dungeon generation rendering successfully**

## Accomplishments

- GridManager utility created for grid/pixel coordinate conversion
- Rot.js Map.Digger generating connected dungeon layouts
- Dungeon rendering with distinct walls (gray) and floors (dark gray)
- 2D map array structure ready for game logic (0 = walkable, 1 = blocked)

## Files Created/Modified

- `src/types/index.ts` - GridPosition type definition
- `src/systems/GridManager.ts` - Coordinate conversion utility
- `src/scenes/GameScene.ts` - Map generation and rendering

## Decisions Made

- Tile size: 32x32 pixels (standard for web roguelikes)
- Grid dimensions: 25x18 tiles (fits 800x600 canvas)
- Used Rot.js Digger algorithm for dungeon generation (creates rooms + corridors)
- Color scheme: Gray walls (#555555), dark gray floors (#222222)

## Issues Encountered

[Document any issues, or state "None"]

## Next Step

Ready for 01-03-PLAN.md - Player Movement & Turn System

</output>
