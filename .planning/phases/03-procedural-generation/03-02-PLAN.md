---
phase: 03-procedural-generation
plan: 02
type: execute
---

<objective>
Implement connectivity validation to ensure all dungeon areas are reachable.

Purpose: Prevents impossible layouts where rooms or items are isolated. Cellular automata and aggressive Digger settings can create disconnected regions - validation with flood fill detects this, tunnel connections repair it. Critical for playable dungeons.

Output: ConnectivityValidator class with flood fill algorithm, tunnel carving for disconnected regions, integration into generation flow guaranteeing single connected dungeon.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-procedural-generation/03-RESEARCH.md
@.planning/phases/03-procedural-generation/03-01-SUMMARY.md
@src/systems/DungeonGenerator.ts
@src/scenes/GameScene.ts

**From 03-01:** Room metadata system in place, DungeonGenerator extracts room data, GameScene stores rooms in this.rooms

**From RESEARCH.md:**
- Common pitfall: Disconnected regions create unreachable areas
- Solution: Flood fill validation finds regions, spanning tree connects them
- Pattern: Find closest points between regions, carve L-shaped tunnels
- Don't hand-roll: Use established flood fill patterns, not custom BFS variants
- Validation prevents: Player spawns but can't reach enemies/items/boss

**Current risk:** ROT.Map.Digger usually connects well but no guarantee - random seeds can create isolated pockets
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ConnectivityValidator class</name>
  <files>src/systems/ConnectivityValidator.ts</files>
  <action>Create class with validateConnectivity(map: number[][]): { connected: boolean; regions: number[][] } method. Implement flood fill starting from each unvisited floor tile (value 0). Use queue-based BFS (not recursive DFS - stack overflow risk on large maps). For each region, store array of tile indices (y * width + x). Return connected: true if 1 region, false if multiple. Include private floodFill helper method using queue, 4-directional neighbors (not 8 - diagonal movement not allowed in game). Follow pattern from RESEARCH.md code examples.</action>
  <verify>TypeScript compiles, class exports validateConnectivity method</verify>
  <done>ConnectivityValidator.ts created with flood fill algorithm, returns region data, compiles without errors</done>
</task>

<task type="auto">
  <name>Task 2: Add tunnel carving to ConnectivityValidator</name>
  <files>src/systems/ConnectivityValidator.ts</files>
  <action>Add connectRegions(map: number[][], region1: number[], region2: number[]): void method. Find closest points between regions using Manhattan distance. Carve L-shaped tunnel: horizontal first (x1 to x2 at y1), then vertical (y1 to y2 at x2), setting map tiles to 0 (floor). Add private carveTunnel(map, x1, y1, x2, y2) helper. Add validateAndRepair(map): boolean method that calls validateConnectivity, if disconnected loops through regions connecting each to region 0, returns true if repairs made. Use pattern from RESEARCH.md - don't invent new connection algorithms.</action>
  <verify>TypeScript compiles, methods added to class</verify>
  <done>connectRegions and validateAndRepair methods implemented, tunnel carving works, compiles without errors</done>
</task>

<task type="auto">
  <name>Task 3: Integrate validation into DungeonGenerator</name>
  <files>src/systems/DungeonGenerator.ts</files>
  <action>Import ConnectivityValidator at top. In generate() method, after digger.create() and before returning, instantiate validator. Call validator.validateAndRepair(map). If repairs made, add console.log('Connected X disconnected regions'). This ensures every generated map is fully connected before being used. Don't add validation to GameScene - belongs in generator where map is created, not where it's consumed.</action>
  <verify>npm run dev compiles, game runs, if disconnected regions exist console shows connection message</verify>
  <done>DungeonGenerator uses ConnectivityValidator, all maps guaranteed connected, console logging works, game runs</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] TypeScript compiles without errors
- [ ] Game loads and runs (http://localhost:5173/)
- [ ] Can test connectivity: player can reach all visible floor tiles
- [ ] No unreachable items or enemies
- [ ] Console may show "Connected X regions" on some generations
</verification>

<success_criteria>
- All 3 tasks completed
- ConnectivityValidator.ts created with flood fill algorithm
- Region connection with tunnel carving implemented
- DungeonGenerator validates and repairs connectivity
- All generated dungeons guaranteed fully connected
- No TypeScript errors
- Game runs, all areas reachable
</success_criteria>

<output>
After completion, create `.planning/phases/03-procedural-generation/03-02-SUMMARY.md`:

# Phase 3 Plan 2: Connectivity Validation Summary

**Guaranteed all dungeon areas reachable via flood fill validation and tunnel repairs**

## Accomplishments

- Implemented flood fill algorithm for region detection
- Created tunnel carving for connecting disconnected regions
- Integrated validation into generation pipeline
- Eliminated impossible dungeon layouts

## Files Created/Modified

- `src/systems/ConnectivityValidator.ts` - Created with flood fill and tunnel carving
- `src/systems/DungeonGenerator.ts` - Integrated connectivity validation

## Decisions Made

- Used queue-based BFS for flood fill (not recursive - stack safety)
- 4-directional neighbors only (matches game movement)
- L-shaped tunnels (horizontal then vertical)
- Validation happens in generator (not GameScene)

## Issues Encountered

[Document any issues or "None"]

## Next Step

Ready for 03-03-PLAN.md (Special Room Placement)
</output>
