---
phase: 03-procedural-generation
plan: 03
type: execute
---

<objective>
Implement intelligent special room placement for boss, treasure, and challenge encounters.

Purpose: Creates meaningful progression - boss at furthest point feels earned, treasure in side branches rewards exploration. Random placement puts boss next to start (speedrun in seconds) or treasure unreachable. Smart placement uses pathfinding distance for progression curve.

Output: Boss room placement at furthest point from start, treasure/challenge room assignment with weighted randomness, spawning logic respecting room types for appropriate entity placement.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-procedural-generation/03-RESEARCH.md
@.planning/phases/03-procedural-generation/03-01-SUMMARY.md
@.planning/phases/03-procedural-generation/03-02-SUMMARY.md
@src/systems/DungeonGenerator.ts
@src/scenes/GameScene.ts
@src/types/index.ts

**From 03-01:** Room metadata system with RoomType enum (START, NORMAL, BOSS, TREASURE, CHALLENGE)
**From 03-02:** Connectivity guaranteed, all rooms reachable

**From RESEARCH.md:**
- Boss at furthest point from start using pathfinding distance (not Euclidean)
- Treasure: 15% of rooms, Challenge: 10% of rooms (from open questions)
- Use ROT.Path.AStar for distance calculation - don't hand-roll pathfinding
- Common pitfall: Boss before objectives, start/exit too close
- Pattern: Calculate path distance to all rooms, assign boss to maximum

**Integration with Phase 2:** Boss rooms spawn tougher enemies (Brute), treasure rooms spawn more items, challenge rooms spawn multiple enemies
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add boss room placement to DungeonGenerator</name>
  <files>src/systems/DungeonGenerator.ts</files>
  <action>In generate() method after room extraction and before return, add assignRoomTypes(map, rooms) private method call. Implement assignRoomTypes: Set rooms[0].type = RoomType.START. For each room, calculate path distance from start room center to room center using ROT.Path.AStar with passableCallback checking map[y][x] === 0. Track room with maximum distance, assign its type to RoomType.BOSS. For remaining rooms: 15% TREASURE (if Math.random() < 0.15), 10% CHALLENGE (else if Math.random() < 0.10), rest NORMAL. Use Rot.js pathfinding - don't implement custom A*. Calculate actual path length not Euclidean distance (research shows boss placement needs walkable path distance).</action>
  <verify>TypeScript compiles, npm run dev runs, console.log room types shows 1 START, 1 BOSS, some TREASURE/CHALLENGE, rest NORMAL</verify>
  <done>Boss placed at furthest point, treasure/challenge rooms assigned, room types properly distributed, compiles and runs</done>
</task>

<task type="auto">
  <name>Task 2: Update enemy spawning to respect room types</name>
  <files>src/scenes/GameScene.ts</files>
  <action>In enemy spawning loop (lines ~134-190), after finding spawn position but before creating enemy, check which room the position belongs to by finding room where x >= room.x && x < room.x + room.width && y >= room.y && y < room.y + room.height. If room.type === RoomType.BOSS, increase Brute spawn chance (enemyType = 2 with 70% chance, else random 0-2). If room.type === RoomType.CHALLENGE, attempt to spawn 2 enemies in that room instead of 1. If room.type === RoomType.START or RoomType.TREASURE, skip enemy spawning for that room (safe zones). Keep NORMAL rooms as current random spawning. Don't change enemy total count calculation - just distribution based on room types.</action>
  <verify>npm run dev runs, boss room has Brute enemy, challenge rooms have multiple enemies, start/treasure rooms safe</verify>
  <done>Enemy spawning respects room types, boss rooms get Brutes, challenge rooms get multiple enemies, safe zones work, game playable</done>
</task>

<task type="auto">
  <name>Task 3: Update item spawning to respect room types</name>
  <files>src/scenes/GameScene.ts</files>
  <action>In item spawning loop (lines ~196-223), after finding spawn position, check which room it belongs to (same logic as Task 2). If room.type === RoomType.TREASURE, spawn 2-3 items instead of 1 (const itemCount = Phaser.Math.Between(2, 3)) and bias toward health/buff potions (70% chance of ItemType.HEALTH_POTION or STRENGTH_POTION/DEFENSE_POTION, else random). If room.type === RoomType.BOSS, skip item spawning (boss room shouldn't have easy healing). If room.type === RoomType.CHALLENGE, spawn throwable items (poison/fire bombs). Keep other rooms as random. This makes room types meaningful for item strategy.</action>
  <verify>npm run dev runs, treasure rooms have multiple items, boss rooms have no items, challenge rooms have bombs</verify>
  <done>Item spawning respects room types, treasure rooms reward exploration, boss rooms are challenging, game balanced</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] TypeScript compiles without errors
- [ ] Game runs (http://localhost:5173/)
- [ ] Boss room spawns at furthest point from start (observe enemy positions)
- [ ] Treasure rooms have multiple items
- [ ] Challenge rooms have multiple/tougher enemies
- [ ] Start room is safe (no enemies)
- [ ] Gameplay feels more structured than random
</verification>

<success_criteria>
- All 3 tasks completed
- Boss room placed at furthest point using pathfinding distance
- Treasure/challenge rooms assigned with weighted randomness
- Enemy spawning respects room types (Brutes in boss, multiple in challenge)
- Item spawning respects room types (abundant in treasure, none in boss)
- Start room safe for player
- Phase 3 complete - procedural generation enhanced
- No TypeScript errors
- Game playable and balanced
</success_criteria>

<output>
After completion, create `.planning/phases/03-procedural-generation/03-03-SUMMARY.md`:

# Phase 3 Plan 3: Special Room Placement Summary

**Intelligent room placement creates meaningful dungeon progression and exploration rewards**

## Accomplishments

- Boss room placed at furthest point using pathfinding distance
- Treasure and challenge rooms assigned with balanced percentages
- Enemy spawning adapted to room types (Brutes in boss, safe zones)
- Item spawning adapted to room types (rich treasure, sparse boss)
- Meaningful progression from start to boss

## Files Created/Modified

- `src/systems/DungeonGenerator.ts` - Added room type assignment with pathfinding
- `src/scenes/GameScene.ts` - Updated enemy and item spawning for room types

## Decisions Made

- Boss placement uses actual path distance, not Euclidean (ensures reachable)
- Treasure rooms: 15%, Challenge rooms: 10% (from research recommendations)
- Start room is safe zone (no enemies)
- Treasure rooms spawn 2-3 items with health/buff bias
- Boss rooms have no items (increases difficulty)
- Challenge rooms spawn throwable items (tactical options)

## Issues Encountered

[Document any issues or "None"]

## Next Step

**Phase 3 complete!** Procedural generation system enhanced with:
- Room metadata system
- Connectivity validation
- Intelligent special room placement

Ready for Phase 4: Meta-Progression Systems
</output>
