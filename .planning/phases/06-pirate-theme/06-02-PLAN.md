# Plan 06-02: Ship Layout & Combat System

## Objective
Create multi-level ship dungeons that replace the generic dungeon generation. Ships serve as tactical puzzle boxes where insight reveals hidden secrets, passages, and the true nature of enemies.

## Prerequisites
- ✅ InsightSystem (from 06-01)
- ✅ Extended types (ShipFaction, ShipAreaType, etc.)
- Existing DungeonGenerator (to reference/replace)
- Existing GridManager

## Overview

Ships are 3-level dungeons:
- **Top Deck (z=0)**: Exposed, ranged advantage, environmental hazards
- **Mid Deck (z=1)**: Crew quarters, tight corridors, chokepoints
- **Lower Deck (z=2)**: Cargo hold, captain's quarters, secrets

Insight reveals:
- **0-29**: Only see main areas, locked doors look impassable
- **30-49**: Notice hollow walls, see patrol patterns
- **50-69**: See hidden passages, identify valuable cargo
- **70-89**: Full map knowledge, see supernatural elements, thrall markers
- **90-100**: Reality layers, ghost echoes, dimensional pockets

## Tasks

### 1. Create Ship Tile System
**File: `src/systems/ShipTileSystem.ts`**

```typescript
import { InsightThreshold, ShipFaction, ShipAreaType, TileVisibility } from '../types';

export enum ShipTileType {
  // Standard tiles
  DECK = 'deck',
  WALL = 'wall',
  DOOR = 'door',
  LOCKED_DOOR = 'locked_door',
  
  // Vertical movement
  STAIRS_DOWN = 'stairs_down',
  STAIRS_UP = 'stairs_up',
  LADDER = 'ladder',
  
  // Environmental
  CARGO = 'cargo',
  RIGGING = 'rigging',
  CANNON = 'cannon',
  MAST = 'mast',
  RAILING = 'railing',
  
  // Hidden (insight-gated)
  HIDDEN_PASSAGE = 'hidden_passage',
  FALSE_WALL = 'false_wall',
  SECRET_HATCH = 'secret_hatch',
  
  // Special (faction-specific)
  RITUAL_CIRCLE = 'ritual_circle',      // Armada
  UNDERWATER_HATCH = 'underwater_hatch', // Drowned
  SMUGGLER_CACHE = 'smuggler_cache',    // Free Captain
  
  // Hazards
  WATER = 'water',
  FIRE = 'fire',
  POWDER_KEG = 'powder_keg'
}

export interface ShipTile {
  x: number;
  y: number;
  z: number;  // Deck level
  type: ShipTileType;
  walkable: boolean;
  blocksVision: boolean;
  
  // Insight revelation
  visibility: TileVisibility;
  revealedDescription?: string;  // What you see at high insight
  
  // Interaction
  interactable: boolean;
  interactionResult?: string;  // What happens when you interact
  
  // State
  occupied: boolean;
  occupantId?: string;
  destroyed: boolean;
}

// Tile definitions with default properties
export const TILE_DEFINITIONS: Record<ShipTileType, Partial<ShipTile>> = {
  [ShipTileType.DECK]: {
    walkable: true,
    blocksVision: false,
    visibility: { alwaysVisible: true, insightRequired: InsightThreshold.IGNORANCE, revealedBySearch: false },
    interactable: false
  },
  [ShipTileType.WALL]: {
    walkable: false,
    blocksVision: true,
    visibility: { alwaysVisible: true, insightRequired: InsightThreshold.IGNORANCE, revealedBySearch: false },
    interactable: false
  },
  [ShipTileType.HIDDEN_PASSAGE]: {
    walkable: true,
    blocksVision: false,
    visibility: { alwaysVisible: false, insightRequired: InsightThreshold.TRUE_SIGHT, revealedBySearch: true },
    interactable: false,
    revealedDescription: 'A hidden passage, invisible to the unenlightened.'
  },
  [ShipTileType.RITUAL_CIRCLE]: {
    walkable: true,
    blocksVision: false,
    visibility: { alwaysVisible: false, insightRequired: InsightThreshold.TRUE_SIGHT, revealedBySearch: false },
    interactable: true,
    revealedDescription: 'A ritual circle etched in gold. The Pale Sign is carved at its center.'
  },
  // ... define all tile types
};
```

### 2. Create Ship Layout Generator
**File: `src/systems/ShipLayoutGenerator.ts`**

```typescript
import { ShipFaction, InsightThreshold } from '../types';
import { ShipTile, ShipTileType, TILE_DEFINITIONS } from './ShipTileSystem';

export interface ShipLayout {
  name: string;
  faction: ShipFaction;
  width: number;
  height: number;
  levels: number;
  tiles: Map<string, ShipTile>;  // Key: "x,y,z"
  spawnPoints: { x: number; y: number; z: number }[];
  enemySpawns: { x: number; y: number; z: number; type: string }[];
  lootLocations: { x: number; y: number; z: number; lootTable: string }[];
  secretAreas: { area: string; insightRequired: InsightThreshold }[];
}

export interface ShipTemplate {
  name: string;
  faction: ShipFaction;
  ascii: {
    topDeck: string[];
    midDeck: string[];
    lowerDeck: string[];
  };
  hiddenFeatures: {
    type: string;
    x: number;
    y: number;
    z: number;
    insightRequired: InsightThreshold;
  }[];
  enemySpawnRules: {
    area: string;
    types: string[];
    count: { min: number; max: number };
  }[];
}

// ASCII legend
const ASCII_MAP: Record<string, ShipTileType> = {
  '.': ShipTileType.DECK,
  '#': ShipTileType.WALL,
  'D': ShipTileType.DOOR,
  'L': ShipTileType.LOCKED_DOOR,
  '<': ShipTileType.STAIRS_UP,
  '>': ShipTileType.STAIRS_DOWN,
  '=': ShipTileType.LADDER,
  'C': ShipTileType.CARGO,
  'R': ShipTileType.RIGGING,
  'X': ShipTileType.CANNON,
  'M': ShipTileType.MAST,
  '|': ShipTileType.RAILING,
  '~': ShipTileType.WATER,
  '*': ShipTileType.POWDER_KEG,
  'H': ShipTileType.HIDDEN_PASSAGE,  // Only in hidden features
  '@': ShipTileType.RITUAL_CIRCLE,   // Only in hidden features
};

export class ShipLayoutGenerator {
  private templates: Map<ShipFaction, ShipTemplate[]>;
  
  constructor() {
    this.templates = new Map();
    this.loadTemplates();
  }
  
  private loadTemplates(): void {
    // Gilded Armada Frigate
    this.templates.set(ShipFaction.GILDED_ARMADA, [{
      name: 'Gilded Frigate',
      faction: ShipFaction.GILDED_ARMADA,
      ascii: {
        topDeck: [
          '################',
          '#..RRRR..RRRR..#',
          '#..............#',
          '#X....MM....X..#',
          '#..............#',
          '#..>........<..#',
          '################'
        ],
        midDeck: [
          '################',
          '#CCCC....CCCC..#',
          '#..D......D....#',
          '#..#...<...#...#',
          '#..#......#....#',
          '#..D......D....#',
          '################'
        ],
        lowerDeck: [
          '################',
          '#CCCCCCCCCCCC..#',
          '#..............#',
          '#.....L........#',
          '#.....#####....#',
          '#.....#...#....#',
          '################'
        ]
      },
      hiddenFeatures: [
        // Pale Messenger shrine behind captain's quarters
        { type: 'PALE_SHRINE', x: 8, y: 5, z: 2, insightRequired: InsightThreshold.TRUE_SIGHT },
        // Hidden passage connecting mid deck
        { type: 'HIDDEN_PASSAGE', x: 7, y: 2, z: 1, insightRequired: InsightThreshold.UNDERSTANDING }
      ],
      enemySpawnRules: [
        { area: 'topDeck', types: ['MARINE', 'MUSKETEER'], count: { min: 2, max: 4 } },
        { area: 'midDeck', types: ['MARINE'], count: { min: 1, max: 2 } },
        { area: 'lowerDeck', types: ['OFFICER'], count: { min: 0, max: 1 } }
      ]
    }]);
    
    // Add more templates...
  }
  
  generate(faction: ShipFaction, difficulty: number = 1): ShipLayout {
    const templates = this.templates.get(faction) || [];
    const template = templates[Math.floor(Math.random() * templates.length)];
    
    if (!template) {
      throw new Error(`No templates for faction: ${faction}`);
    }
    
    const layout: ShipLayout = {
      name: template.name,
      faction: faction,
      width: template.ascii.topDeck[0].length,
      height: template.ascii.topDeck.length,
      levels: 3,
      tiles: new Map(),
      spawnPoints: [],
      enemySpawns: [],
      lootLocations: [],
      secretAreas: []
    };
    
    // Parse ASCII for each deck
    this.parseAsciiDeck(template.ascii.topDeck, 0, layout);
    this.parseAsciiDeck(template.ascii.midDeck, 1, layout);
    this.parseAsciiDeck(template.ascii.lowerDeck, 2, layout);
    
    // Add hidden features
    for (const feature of template.hiddenFeatures) {
      this.addHiddenFeature(layout, feature);
    }
    
    // Generate enemy spawns based on rules and difficulty
    this.generateEnemySpawns(layout, template.enemySpawnRules, difficulty);
    
    return layout;
  }
  
  private parseAsciiDeck(ascii: string[], z: number, layout: ShipLayout): void {
    for (let y = 0; y < ascii.length; y++) {
      for (let x = 0; x < ascii[y].length; x++) {
        const char = ascii[y][x];
        const tileType = ASCII_MAP[char] || ShipTileType.DECK;
        const key = `${x},${y},${z}`;
        
        const defaults = TILE_DEFINITIONS[tileType] || {};
        
        layout.tiles.set(key, {
          x, y, z,
          type: tileType,
          walkable: defaults.walkable ?? true,
          blocksVision: defaults.blocksVision ?? false,
          visibility: defaults.visibility ?? { 
            alwaysVisible: true, 
            insightRequired: InsightThreshold.IGNORANCE, 
            revealedBySearch: false 
          },
          interactable: defaults.interactable ?? false,
          occupied: false,
          destroyed: false
        });
        
        // Track spawn points (stairs up on top deck)
        if (tileType === ShipTileType.STAIRS_UP && z === 0) {
          layout.spawnPoints.push({ x, y, z });
        }
      }
    }
  }
  
  private addHiddenFeature(
    layout: ShipLayout, 
    feature: { type: string; x: number; y: number; z: number; insightRequired: InsightThreshold }
  ): void {
    const key = `${feature.x},${feature.y},${feature.z}`;
    const existingTile = layout.tiles.get(key);
    
    if (existingTile) {
      // Overlay hidden feature
      existingTile.visibility = {
        alwaysVisible: false,
        insightRequired: feature.insightRequired,
        revealedBySearch: feature.type === 'HIDDEN_PASSAGE'
      };
      
      layout.secretAreas.push({
        area: feature.type,
        insightRequired: feature.insightRequired
      });
    }
  }
  
  private generateEnemySpawns(
    layout: ShipLayout,
    rules: { area: string; types: string[]; count: { min: number; max: number } }[],
    difficulty: number
  ): void {
    // Implementation: Find valid floor tiles in each area
    // Spawn enemies based on rules and difficulty
  }
}
```

### 3. Create Insight Revelation Manager
**File: `src/systems/InsightRevealationManager.ts`**

```typescript
import { InsightSystem } from './InsightSystem';
import { ShipLayout, ShipTile } from './ShipLayoutGenerator';
import { InsightThreshold } from '../types';

export interface RevealedContent {
  tile: ShipTile;
  revealType: 'full' | 'hint' | 'hidden';
  description?: string;
}

export class InsightRevealationManager {
  private insightSystem: InsightSystem;
  
  constructor(insightSystem: InsightSystem) {
    this.insightSystem = insightSystem;
  }
  
  /**
   * Filter tiles based on current insight level
   */
  getVisibleTiles(layout: ShipLayout): RevealedContent[] {
    const results: RevealedContent[] = [];
    const currentInsight = this.insightSystem.getCurrent();
    
    for (const tile of layout.tiles.values()) {
      const content = this.revealTile(tile, currentInsight);
      results.push(content);
    }
    
    return results;
  }
  
  /**
   * Determine how a specific tile appears at current insight
   */
  revealTile(tile: ShipTile, insight: number): RevealedContent {
    const { visibility } = tile;
    
    // Always visible tiles
    if (visibility.alwaysVisible) {
      return { tile, revealType: 'full' };
    }
    
    // Check insight threshold
    if (insight >= visibility.insightRequired) {
      return { 
        tile, 
        revealType: 'full',
        description: tile.revealedDescription
      };
    }
    
    // Partial reveal at lower insight
    if (insight >= visibility.insightRequired - 20) {
      return {
        tile,
        revealType: 'hint',
        description: 'Something seems off here...'
      };
    }
    
    // Hidden
    return { tile, revealType: 'hidden' };
  }
  
  /**
   * Check if player can see thrall markers on NPCs
   */
  canSeeThralls(): boolean {
    return this.insightSystem.meetsThreshold(InsightThreshold.UNDERSTANDING);
  }
  
  /**
   * Check if player can see Pale Messenger influence
   */
  canSeePaleInfluence(): boolean {
    return this.insightSystem.meetsThreshold(InsightThreshold.TRUE_SIGHT);
  }
  
  /**
   * Check if player can see reality layers
   */
  canSeeRealityLayers(): boolean {
    return this.insightSystem.meetsThreshold(InsightThreshold.TRANSCENDENCE);
  }
  
  /**
   * Get flavor text for insight level at current location
   */
  getInsightFlavorText(tile: ShipTile): string | null {
    const insight = this.insightSystem.getCurrent();
    
    if (insight < InsightThreshold.SUSPICION) {
      return null;  // No special perception
    }
    
    if (insight >= InsightThreshold.TRANSCENDENCE) {
      return 'Reality ripples. You see the ship as it was, as it is, as it might be.';
    }
    
    if (insight >= InsightThreshold.TRUE_SIGHT) {
      return 'Golden threads of influence weave through the ship\'s structure.';
    }
    
    if (insight >= InsightThreshold.UNDERSTANDING) {
      return 'You sense hidden passages. The walls have secrets.';
    }
    
    if (insight >= InsightThreshold.SUSPICION) {
      return 'Something feels wrong. The ship holds more than it shows.';
    }
    
    return null;
  }
}
```

### 4. Update Rendering for Multi-Level Ships
**File: Update `src/scenes/GameScene.ts`**

Key changes:
- Render current deck level
- Show stairs indicators
- Dim other levels
- Insight-based tile visibility
- Faction-specific tile colors

### 5. Create Ship Template Data Files
**File: `src/data/ship-templates/gilded-frigate.json`**

```json
{
  "name": "Gilded Frigate",
  "faction": "GILDED_ARMADA",
  "description": "A well-maintained Armada vessel. Too clean. Too orderly.",
  "size": { "width": 16, "height": 7 },
  "levels": 3,
  "ascii": {
    "topDeck": [
      "################",
      "#..RRRR..RRRR..#",
      "#..............#",
      "#X....MM....X..#",
      "#..............#",
      "#..>........<..#",
      "################"
    ],
    "midDeck": "...",
    "lowerDeck": "..."
  },
  "hiddenFeatures": [
    {
      "id": "pale_shrine",
      "type": "RITUAL_CIRCLE",
      "position": { "x": 8, "y": 5, "z": 2 },
      "insightRequired": 70,
      "description": "A shrine to the Pale Messenger, hidden in the captain's quarters. The crew doesn't know it exists.",
      "onDiscovery": {
        "insightGain": 15,
        "paleAttentionGain": 10,
        "journalEntry": "Found a hidden shrine aboard the Armada vessel. Golden symbols I don't recognize..."
      }
    }
  ],
  "lore": {
    "lowInsight": "A standard Armada frigate. Disciplined crew, clean decks.",
    "mediumInsight": "The crew moves with unnatural precision. They use the same phrases.",
    "highInsight": "The ship itself is wrong. Too many corners. The Pale Sign is carved into every beam."
  }
}
```

## Verification

1. **Ship Generation**
   - Generate ship for each faction
   - Verify all tiles placed correctly
   - Check hidden features exist

2. **Insight Revelation**
   - At 0 insight: Hidden passages invisible
   - At 50 insight: "Something seems off" hints
   - At 70 insight: Full revelation

3. **Multi-Level Navigation**
   - Can move between decks via stairs
   - Current deck renders correctly
   - Other decks show as dimmed/minimap

4. **Template Parsing**
   - ASCII templates parse correctly
   - Hidden features overlay properly
   - Enemy spawns generate in valid locations

## Files Changed/Created
- `src/systems/ShipTileSystem.ts` - NEW
- `src/systems/ShipLayoutGenerator.ts` - NEW
- `src/systems/InsightRevealationManager.ts` - NEW
- `src/data/ship-templates/gilded-frigate.json` - NEW
- `src/data/ship-templates/drowned-hulk.json` - NEW
- `src/data/ship-templates/free-merchant.json` - NEW
- `src/scenes/GameScene.ts` - MODIFIED (rendering)

## Integration Points
- GameScene uses ShipLayoutGenerator instead of DungeonGenerator
- InsightRevealationManager filters visible content
- SessionStateManager tracks which secrets discovered

## Next Steps
After completing ship layouts, proceed to:
- 06-03: Pirate enemy types that spawn on ships
- 06-04: Crew system for ship-to-ship combat
